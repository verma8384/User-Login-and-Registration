<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="d-flex">
        <!-- Sidebar -->
        <nav class="sidebar shadow" style="height: 100vh;">
            <h5 class="text-center p-3"><b>Menu</b></h5>
            <a href="dashboard.html" class="mb-2">DashBoard</a>
            <a href="index.html" class="mb-2">Employee</a>
            <a href="change_password.html" class="mb-2">Password</a>
            <a href="users.html" class="mb-2">Users</a>
            <a href="product.html" class="mb-2"><b>Products</b></a>
        </nav>

        <!-- Main Content -->
        <div class="flex-grow-1">
            <!-- Header -->
            <header class="header p-3 d-flex justify-content-between align-items-center shadow">
                <h3 class="m-0">Products</h3>
                <button id="logoutButton" class="btn btn-sm btn-danger btn-logout" data-bs-toggle="modal"
                    data-bs-target="#logoutModal">Logout</button>
            </header>

            <!-- content -->
            <div class="container my-4">
                <h2 id="formTitle">Add Product</h2>
                <form id="productForm" class="p-4 border rounded row g-10">
                    <div id="text-right" class="text-right col-12" style="text-align: right;">
                        <button type="button" class="btn btn-outline-danger w-15"
                            onclick="window.location.href = 'product.html'">X</button>
                    </div><br>
                    <div class="col-md-6" style="margin-top: 10px;">
                        <label for="productId" class="form-label">ID</label>
                        <input type="number" id="productId" class="form-control" required>
                    </div>
                    <div class="col-md-6" style="margin-top: 10px;">
                        <label for="productTitle" class="form-label">Title</label>
                        <input type="text" id="productTitle" class="form-control" required>
                    </div>
                    <div class="col-md-6" style="margin-top: 10px;">
                        <label for="productPrice" class="form-label">Price</label>
                        <input type="number" id="productPrice" class="form-control" step="0.01" required>
                    </div>
                    <div class="col-md-6" style="margin-top: 10px;">
                        <label for="productDescription" class="form-label">Description</label>
                        <input type="text" id="productDescription" class="form-control" step="0.01" required>
                    </div>
                    <div class="col-md-6" style="margin-top: 10px;">
                        <label for="productCategory" class="form-label">Category</label>
                        <input type="text" id="productCategory" class="form-control" required>
                    </div>
                    <div class="col-md-6" style="margin-top: 10px;">
                        <label for="productImage" class="form-label">Image URL</label>
                        <input type="url" id="productImage" class="form-control" required>
                    </div>
                    <div class="col-md-6" style="margin-top: 10px;">
                        <label for="productRating" class="form-label">Rating</label>
                        <input type="number" id="productRating" class="form-control" step="0.1" required>
                    </div>
                    <div class="col-md-6 position-relative" id="imagePreviewContainer"
                        style="display: none; margin-top: 10px;">
                        <!-- Image preview -->
                        <img id="imagePreview" src="" alt="Image Preview" class="img-thumbnail"
                            style="width: 100px; height: 100px;">
                        <!-- Close button -->
                        <button type="button" class="btn btn-outline-danger" aria-label="Close" id="removeImageButton"
                            title="Remove image">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="d-flex" style="margin-top: 15px;">
                        <button type="submit" class="btn btn-primary" id="saveButton">Add</button>
                        <button type="button" class="btn btn-outline-danger"
                            onclick="window.location.href = 'product.html'">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Logout Modal -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logoutModalLabel">Confirm Logout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to log out?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmLogout">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationModalLabel">Notification</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="notificationMessage">
                    <!-- Message will be inserted dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Expired Modal -->
    <div class="modal fade" id="sessionModal" tabindex="-1" aria-labelledby="sessionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sessionModalLabel">Session Expired</h5>
                </div>
                <div class="modal-body">
                    Your session has expired. login Again!
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="goToLogin">Login</button>
                </div>
            </div>
        </div>
    </div>

    <script>

        document.addEventListener('DOMContentLoaded', function () {
            const employees = JSON.parse(localStorage.getItem("users"))

            // Function to check if the user email exists in the employees array
            const isUserValid = (userEmail) => {
                return employees.some(employee => employee.email === userEmail);
            };

            // Check for user session
            if (!sessionStorage.getItem("user") || !localStorage.getItem("user") || !isUserValid(localStorage.getItem("user")) || !(sessionStorage.getItem("user")===localStorage.getItem("user"))) {
                sessionStorage.removeItem("user");
                localStorage.removeItem("user");
                // Show modal if no user session
                const sessionModal = new bootstrap.Modal(document.getElementById('sessionModal'), {
                    backdrop: 'static', // Prevent closing the modal by clicking outside
                    keyboard: false    // Prevent closing the modal using the keyboard
                });
                sessionModal.show();

                // Redirect to login page after the modal is closed
                document.getElementById('goToLogin').addEventListener('click', function () {
                    window.location.href = "login.html";
                });
            } else {
                // Logout confirmation
                document.getElementById('confirmLogout').addEventListener('click', function () {
                    sessionStorage.removeItem("user");
                    localStorage.removeItem("user");
                    window.location.href = "login.html"; // Redirect to the login page
                });

                const urlParams = new URLSearchParams(window.location.search);
                const productId = urlParams.get("id");
                const form = document.getElementById("productForm");
                const formTitle = document.getElementById("formTitle");

                if (productId) {
                    // Editing an existing product
                    formTitle.textContent = "Edit Product";
                    saveButton.textContent = "Save"
                    document.getElementById("productId").value = productId;
                    document.getElementById("productId").setAttribute("readonly", true);

                    // Fetch product data and populate fields
                    fetch(`https://fakestoreapi.com/products/${productId}`)
                        .then((response) => response.json())
                        .then((product) => {
                            document.getElementById("productTitle").value = product.title;
                            document.getElementById("productPrice").value = product.price;
                            document.getElementById("productDescription").value = product.description;
                            document.getElementById("productCategory").value = product.category;
                            document.getElementById("productImage").value = product.image;
                            document.getElementById("productRating").value = product.rating.rate;
                            updateImagePreview(product.image);
                        })
                        .catch((error) => console.error("Error fetching product:", error));
                }

                // Utility to show error messages
                function showError(input, message) {
                    input.classList.add("is-invalid");
                    if (!input.nextElementSibling || !input.nextElementSibling.classList.contains("invalid-feedback")) {
                        const errorDiv = document.createElement("div");
                        errorDiv.classList.add("invalid-feedback");
                        errorDiv.textContent = message;
                        input.parentNode.appendChild(errorDiv);
                    }
                }

                // Utility to clear error messages
                function clearError(input) {
                    input.classList.remove("is-invalid");
                    if (input.nextElementSibling && input.nextElementSibling.classList.contains("invalid-feedback")) {
                        input.nextElementSibling.remove();
                    }
                }

                // Real-time validation for each input field (triggers both when typing and when the user clicks away)
                document.querySelectorAll("#productForm input").forEach((input) => {
                    // Trigger validation on typing
                    input.addEventListener("input", () => validateInput(input));

                    // Trigger validation when user leaves the field (blur event)
                    input.addEventListener("blur", () => validateInput(input));
                });

                // Modify the validateInput function to accept the individual input
                function validateInput(input) {
                    let isValid = true;

                    // Validate Product ID (number and uniqueness)
                    const productIdInput = document.getElementById("productId");
                    if (productIdInput === input || input === undefined) {
                        if (productIdInput.value.trim() === "" || isNaN(productIdInput.value)) {
                            showError(productIdInput, "Product ID must be a valid number.");
                            isValid = false;
                        } else {
                            fetch(`https://fakestoreapi.com/products`)
                                .then((response) => response.json())
                                .then((products) => {
                                    const productExists = products.some(
                                        (product) => product.id == productIdInput.value
                                    );
                                    if (productExists && !productIdInput.hasAttribute("readonly")) {
                                        showError(productIdInput, "Product ID must be unique.");
                                        isValid = false;
                                    } else {
                                        clearError(productIdInput);
                                    }
                                });
                        }
                    }

                    // Validate Title (non-empty)
                    const productTitleInput = document.getElementById("productTitle");
                    if (productTitleInput === input || input === undefined) {
                        if (productTitleInput.value.trim() === "") {
                            showError(productTitleInput, "Title cannot be empty.");
                            isValid = false;
                        } else {
                            clearError(productTitleInput);
                        }
                    }

                    // Validate Price (positive number)
                    const productPriceInput = document.getElementById("productPrice");
                    if (productPriceInput === input || input === undefined) {
                        if (
                            productPriceInput.value.trim() === "" ||
                            isNaN(productPriceInput.value) ||
                            parseFloat(productPriceInput.value) <= 0
                        ) {
                            showError(productPriceInput, "Price must be a positive number.");
                            isValid = false;
                        } else {
                            clearError(productPriceInput);
                        }
                    }

                    // Validate Description (non-empty)
                    const productDescriptionInput = document.getElementById("productDescription");
                    if (productDescriptionInput === input || input === undefined) {
                        if (productDescriptionInput.value.trim() === "") {
                            showError(productDescriptionInput, "Description cannot be empty.");
                            isValid = false;
                        } else {
                            clearError(productDescriptionInput);
                        }
                    }

                    // Validate Category (non-empty)
                    const productCategoryInput = document.getElementById("productCategory");
                    if (productCategoryInput === input || input === undefined) {
                        if (productCategoryInput.value.trim() === "") {
                            showError(productCategoryInput, "Category cannot be empty.");
                            isValid = false;
                        } else {
                            clearError(productCategoryInput);
                        }
                    }

                    // Validate Image URL (valid URL format)
                    const productImageInput = document.getElementById("productImage");
                    if (productImageInput === input || input === undefined) {
                        try {
                            new URL(productImageInput.value);
                            clearError(productImageInput);
                        } catch (e) {
                            showError(productImageInput, "Image URL must be valid.");
                            isValid = false;
                        }
                    }

                    // Validate Rating (number between 0 and 5)
                    const productRatingInput = document.getElementById("productRating");
                    if (productRatingInput === input || input === undefined) {
                        if (
                            productRatingInput.value.trim() === "" ||
                            isNaN(productRatingInput.value) ||
                            parseFloat(productRatingInput.value) < 0 ||
                            parseFloat(productRatingInput.value) > 5
                        ) {
                            showError(productRatingInput, "Rating must be between 0 and 5.");
                            isValid = false;
                        } else {
                            clearError(productRatingInput);
                        }
                    }

                    return isValid;
                }

                // Real-time image preview
                const productImageInput = document.getElementById("productImage");
                const imagePreviewContainer = document.getElementById("imagePreviewContainer");
                const imagePreview = document.getElementById("imagePreview");
                const removeImageButton = document.getElementById("removeImageButton");

                // Function to update the image preview dynamically
                function updateImagePreview(url) {
                    if (url) {
                        try {
                            // Validate URL
                            new URL(url);
                            imagePreview.src = url;
                            imagePreviewContainer.style.display = "block";
                            clearError(productImageInput); // Clear validation errors
                        } catch (e) {
                            imagePreviewContainer.style.display = "none"; // Hide preview for invalid URL
                        }
                    } else {
                        imagePreviewContainer.style.display = "none"; // Hide preview if input is empty
                    }
                }

                // Event listener for the Image URL input field
                productImageInput.addEventListener("input", () => {
                    updateImagePreview(productImageInput.value.trim());
                });

                // Handle remove button click
                removeImageButton.addEventListener("click", () => {
                    productImageInput.value = ""; // Clear the input field
                    imagePreviewContainer.style.display = "none"; // Hide the preview container
                });

                // Handle form submission
                form.addEventListener("submit", (event) => {
                    event.preventDefault(); // Prevent default form submission
                    if (validateInput()) {
                        const data = {
                            id: document.getElementById("productId").value,
                            title: document.getElementById("productTitle").value,
                            price: parseFloat(document.getElementById("productPrice").value),
                            description: document.getElementById("productDescription").value,
                            category: document.getElementById("productCategory").value,
                            image: document.getElementById("productImage").value,
                            rating: {
                                rate: parseFloat(document.getElementById("productRating").value),
                                count: 0, // Placeholder
                            },
                        };

                        const productId = document.getElementById("productId").value;
                        const method = productId ? "PUT" : "POST";
                        const url = productId
                            ? `https://fakestoreapi.com/products/${productId}`
                            : "https://fakestoreapi.com/products";

                        fetch(url, {
                            method: method,
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(data),
                        })
                            .then((response) => {
                                if (response.ok) {
                                    showNotification("Product saved successfully.");
                                    setTimeout(() => {
                                        window.location.href = "product.html";
                                    }, 2000);
                                } else {
                                    showNotification("Failed to save product.");
                                }
                            })
                            .catch((error) => {
                                console.error("Error saving product:", error);
                                showNotification("An error occurred. Please try again.");
                            });
                    } else {
                        showNotification("Please correct the errors in the form.");
                    }
                });

                // Notification utility
                function showNotification(message) {
                    const notificationMessage = document.getElementById("notificationMessage");
                    const notificationModal = new bootstrap.Modal(document.getElementById("notificationModal"));

                    notificationMessage.textContent = message;
                    notificationModal.show();
                }
            }
        });

    </script>
</body>

</html>